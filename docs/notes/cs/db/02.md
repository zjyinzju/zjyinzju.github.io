# Chapter 2 The Relational Model

## Structure of Relational Databases
ç›´è§‚æ¥çœ‹ï¼Œä¸€ä¸ªç®€å•çš„å…³ç³»å¯ä»¥å¯è§†åŒ–ä¸ºä¸€å¼ è¡¨æ ¼ï¼Œå…¶ä¸­æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªå…ƒç»„ï¼Œæ¯ä¸€åˆ—ä»£è¡¨ä¸€ä¸ªå±æ€§ã€‚

??? eg 
    <center>
    ![](./fig/c2_1.png)
    </center>

### Basic Structure
!!! definition "Relation"
    ç»™å®šé›†åˆ $D_1, D_2, \cdots, D_n$ï¼Œä¸€ä¸ªå…³ç³» $r$ æ˜¯ $D_1 \times D_2 \times \cdots \times D_n$ çš„ä¸€ä¸ªå­é›†ã€‚

    å› æ­¤ï¼Œä¸€ä¸ªå…³ç³»å¯ä»¥è¢«è§†ä¸ºä¸€ä¸ª $n$ å…ƒç»„ $(a_1, a_2, \cdots, a_n)$ çš„é›†åˆï¼Œå…¶ä¸­ $a_i \in D_i$ã€‚

    ??? eg 
        <center>
        ![](./fig/c2_2.png)
        </center>

### Relational Schema and Instance
+ Schema æ˜¯æŠ½è±¡çš„ï¼Œæè¿°äº†å…³ç³»çš„ç»“æ„ï¼›è€Œ Instance æ˜¯å…·ä½“çš„ï¼Œæè¿°äº†å…³ç³»ä¸­çš„å…ƒç»„ã€‚
    + $A_1, A_2, \cdots, A_n$ æ˜¯ **attributes**, åˆ™ $R = (A_1, A_2, \cdots, A_n)$ æ˜¯ä¸€ä¸ª relation schema
    + $r(R)$ æ˜¯æŒ‡ relation instance $r$ æ˜¯å®šä¹‰åœ¨ schema $R$ ä¸Šçš„
    + ä¸€ä¸ªå…³ç³»å½“ä¸‹çš„å€¼å¯ä»¥ç”¨ä¸€ä¸ªè¡¨æ ¼è¡¨ç¤ºï¼Œå…¶ä¸­æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªå…ƒç»„(tuple)ï¼Œæ¯ä¸€åˆ—ä»£è¡¨ä¸€ä¸ªå±æ€§(attribute)

### Attributes
+ Domain æ˜¯å±æ€§çš„å–å€¼èŒƒå›´
+ Atomic: å±æ€§çš„å€¼æ˜¯ä¸å¯åˆ†çš„ï¼Œå³å®ƒåº”è¯¥æ˜¯ä¸€ä¸ªå•ä¸€çš„å€¼è€Œéä¸€ä¸ªé›†åˆ
+ Null: å±æ€§çš„å€¼å¯ä»¥æ˜¯ NULLï¼Œè¡¨ç¤ºæœªçŸ¥æˆ–ä¸é€‚ç”¨ï¼›ä¸”æ¯ä¸€ä¸ªdomainéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å€¼ NULL

## Database Schema and Instances
ç±»ä¼¼äºå…³ç³»ï¼Œæ•°æ®åº“ä¹Ÿæœ‰ schema å’Œ instance çš„æ¦‚å¿µã€‚
??? eg 
    <center>
    ![](./fig/c2_3.png)
    </center>

## Keys
é¦–å…ˆï¼ŒK $\subseteq$ Rï¼Œå³ K æ˜¯ å…³ç³» R çš„ä¸€ä¸ªå­é›†ã€‚

!!! definition "Superkey"
    K çš„å€¼è¶³ä»¥å”¯ä¸€æ ‡è¯†r(R)çš„ä¸€ä¸ªtupleï¼Œåˆ™ K æ˜¯ R çš„ superkeyã€‚
    
    ä¾‹å¦‚ï¼Œ$\left\{ ID \right\}$ å’Œ $\left\{ ID, Name \right\}$ éƒ½æ˜¯  Instructor çš„ superkeyã€‚

!!! definition "Candidate Key"
    å¦‚æœ K æ˜¯ superkeyï¼Œä¸”æ²¡æœ‰çœŸå­é›†æ˜¯ superkeyï¼Œåˆ™ K æ˜¯ candidate keyã€‚

    ä¾‹å¦‚ï¼ŒInstructor çš„ candidate key æ˜¯ $\left\{ ID \right\}$ å’Œ $\left\{ Name \right\}$ã€‚

!!! definition "Primary Key"
    candidate keys ä¸­çš„ä¸€ä¸ªè¢«é€‰ä¸º primary keyã€‚

!!! definition "Foreign Key"
    + å¤–é”®æ˜¯ä¸€ä¸ªè¡¨ä¸­çš„ä¸€ç»„Attributesï¼Œå®ƒå¼•ç”¨å¦ä¸€ä¸ªè¡¨ä¸­çš„**ä¸»é”®**
    + Foreign key constraints ç¡®ä¿äº†å¼•ç”¨è¡¨$r_1$ä¸­çš„å¤–é”®Açš„å€¼å¿…é¡»æ˜¯è¢«å¼•ç”¨è¡¨$r_2$ä¸­çš„ä¸»é”®Bçš„å€¼çš„å­é›†ï¼›å³å¯¹äº$r_1$ä¸­çš„æ¯ä¸€ä¸ªå…ƒç»„(è¡Œ)ï¼Œå±æ€§ $A$ çš„å€¼å¿…é¡»åœ¨$r_2$çš„æŸä¸ªå…ƒç»„çš„ä¸»é”® $B$ ä¸­å‡ºç°ã€‚
    + Referential integrity: å¤–é”®çº¦æŸç¡®ä¿äº†å¼•ç”¨å®Œæ•´æ€§ï¼Œå³åœ¨å¼•ç”¨å…³ç³»r1çš„ä»»ä½•å…ƒç»„ä¸­ï¼Œå‡ºç°åœ¨æŒ‡å®šå±æ€§ A ä¸­çš„å€¼ä¹Ÿå¿…é¡»å‡ºç°åœ¨è¢«å¼•ç”¨å…³ç³» r2 çš„è‡³å°‘ä¸€ä¸ªå…ƒç»„çš„æŒ‡å®šå±æ€§ B ä¸­ã€‚


## Schema Diagrams
<center>
![](./fig/c2_4.png)
</center>

## Relational Query Languages

+ Procedural è€Œé Declarative
+ Relational Algebra / Tuple Relational Calculus / Domain Relational Calculus ä¸‰è€…ç­‰ä»·
+ æˆ‘ä»¬ä¸»è¦å…³æ³¨ Relational Algebra
    + éå›¾çµå®Œå¤‡
    + æœ‰6ç§åŸºæœ¬æ“ä½œ
    
## The Relational Algebra
æœ‰å…­ç§åŸºæœ¬æ“ä½œï¼š

+ Selection **$\sigma$** : é€‰æ‹©æ»¡è¶³æŸä¸€æ¡ä»¶çš„**tuple**

    ??? eg 
        <center>
        ![](./fig/c2_5.png)
        </center>
        æ‰§è¡Œ $\sigma_{A=B \land D > 5}(r)$ å¾—åˆ°ï¼š
        <center>
        ![](./fig/c2_6.png)
        </center>

+ Projection **$\pi$** : é€‰æ‹©æŸäº›**attributes**

    ??? eg 
        <center>
        ![](./fig/c2_7.png)
        </center>
        æ‰§è¡Œ $\pi_{A, C}(r)$ å¾—åˆ°ï¼š
        <center>
        ![](./fig/c2_8.png)
        </center>
    
+ Union **$\cup$** : ä¸¤ä¸ªå…³ç³»çš„å¹¶é›†ï¼Œè¦æ±‚ä¸¤ä¸ªå…³ç³»çš„ attribute æ•°é‡ç›¸åŒï¼Œä¸” attribute çš„ domain åº”å½“æ˜¯å…¼å®¹çš„ï¼ˆä¾‹å¦‚æ•°æ®ç±»å‹ç­‰åº”å½“ç›¸åŒï¼‰

    ??? eg 
        <center>
        ![](./fig/c2_9.png)
        </center>
        æ‰§è¡Œ $r \cup s$ å¾—åˆ°ï¼š
        <center>
        ![](./fig/c2_10.png)
        </center>

+ Set Difference **$-$** : ä¸¤ä¸ªå…³ç³»çš„å·®é›†ï¼Œè¦æ±‚ä¸ Union ç›¸åŒ

    ??? eg 
        <center>
        ![](./fig/c2_11.png)
        </center>
        æ‰§è¡Œ $r - s$ å¾—åˆ°ï¼š
        <center>
        ![](./fig/c2_12.png)
        </center>

+ Cartesian Product **$\times$** : ä¸¤ä¸ªå…³ç³»çš„ç¬›å¡å°”ç§¯ï¼Œå³ä¸¤ä¸ªå…³ç³»çš„æ‰€æœ‰å¯èƒ½ç»„åˆ

    ??? eg 
        <center>
        ![](./fig/c2_13.png)
        </center>
        æ‰§è¡Œ $r \times s$ å¾—åˆ°ï¼š
        <center>
        ![](./fig/c2_14.png)
        </center>

+ Rename **$\rho$** : é‡å‘½åå…³ç³»æˆ–å±æ€§
    + é‡å‘½åå…³ç³»ï¼š$\rho_{r_1}(r)$
    + é‡å‘½åå±æ€§ï¼š$\rho_x(A_1, A_2, \cdots, A_n)(r)$

!!! example "Find the largest salary in university"
    + éœ€è¦æ¯”è¾ƒä¸åŒæ•™å¸ˆçš„salaryï¼Œå› æ­¤éœ€è¦é‡å‘½åä¸€æ¬¡åç”¨ç¬›å¡å°”ç§¯å°†æ‰€æœ‰å¯èƒ½çš„ç»„åˆæ‰¾å‡ºï¼š
    <center>
    $Instructor \times \rho_d (Instructor)$
    </center>
    + è¿›è¡Œåé€‰ï¼Œæ‰¾å‡ºæ‰€æœ‰ä¸æ˜¯æœ€å¤§salaryçš„ç»„åˆï¼š
    <center>
    $\sigma_{Instructor.salary < d.salary}(Instructor \times \rho_d(Instructor)$
    </center>
    + é€‰æ‹©salaryå±æ€§ï¼ŒåŸè¡¨å‡å»ä¸Šä¸€æ­¥çš„ç»“æœå³å¯ï¼š
    <center>
    $\pi_{salary}(Instructor) - \pi_{Instructor.salary}(\sigma_{Instructor.salary < d.salary}(Instructor \times \rho_d(Instructor))$
    </center>

### Additional Operations
+ Intersection **$\cap$** : ä¸¤ä¸ªå…³ç³»çš„äº¤é›†ï¼Œ
å¯è¡¨è¾¾ä¸º $r \cap s = r - (r - s)$

    ??? eg 
        <center>
        ![](./fig/c2_15.png)
        </center>
        æ‰§è¡Œ $r \cap s$ å¾—åˆ°ï¼š
        <center>
        ![](./fig/c2_16.png)
        </center>

+ Natural Join **$\bowtie$** : ä¸¤ä¸ªå…³ç³»çš„è‡ªç„¶è¿æ¥ï¼Œå°†ä¸¤ä¸ªå…³ç³»ç›¸ä¹˜ï¼Œç„¶åé€‰æ‹©ä¸¤ä¸ªå…³ç³»ä¸­ç›¸åŒå±æ€§çš„å€¼ç›¸ç­‰çš„å…ƒç»„

    ??? eg 
        $R = (A, B, C, D)$, $S = (B, D, E)$

        + $r \bowtie s = \Pi_{r.A, r.B, r.C, r.D, s.E}(\sigma_{r.B = s.B \land r.D = s.D}(r \times s))$

    ??? extra "natural join and Theta join"
        + natural join: æ»¡è¶³äº¤æ¢å¾‹å’Œç»“åˆå¾‹
        + theta join: $r \bowtie_{\theta} s = \sigma_{\theta}(r \times s)$

+ Outer Join **$\ltimes$**, **$\rtimes$** **$âŸ—$**:  é¿å…äº†è¿æ¥è¿‡ç¨‹ä¸­ä¿¡æ¯çš„ä¸¢å¤±ã€‚å…ˆè¿›è¡Œè‡ªç„¶è¿æ¥ç„¶åå°†æ²¡æœ‰åŒ¹é…çš„å…ƒç»„è¡¥å…¨ï¼Œç¼ºå¤±çš„å±æ€§ç”¨ NULL å¡«å……

    !!! eg 
        <center>
        ![](./fig/c2_17.png)
        </center>
        
        === "natural join"
            $Instructor \bowtie teaches$ å¾—åˆ°ï¼š
            <center>
            ![](./fig/c2_18.png)
            </center>
        === "left outer join"
            $Instructor \ltimes teaches$ å¾—åˆ°ï¼š
            <center>
            ![](./fig/c2_19.png)
            </center>
        === "right outer join"
            $Instructor \rtimes teaches$ å¾—åˆ°ï¼š
            <center>
            ![](./fig/c2_20.png)
            </center>
        === "full outer join"
            $Instructor âŸ— teaches$ å¾—åˆ°ï¼š
            <center>
            ![](./fig/c2_21.png)
            </center>
    
    !!! note "Outer Join using Joins"
        + å·¦å¤–è¿æ¥ï¼šå·¦å¤–è¿æ¥è¿”å›å…³ç³»ğ‘Ÿä¸­çš„æ‰€æœ‰è¡Œï¼Œä»¥åŠä¸ğ‘ åŒ¹é…çš„è¡Œã€‚å¦‚æœæ²¡æœ‰åŒ¹é…çš„è¡Œï¼Œç»“æœä¼šä¸ºğ‘ ä¸­çš„åˆ—å¡«å……ç©ºå€¼ï¼š
        <center>
        $r \ltimes s = (r \bowtie s) \cup (r - \pi_{R} (r \bowtie s) \times \left\{ NULL, NULL, \cdots \right\})$ 
        </center>
        + å³å¤–è¿æ¥ï¼šå³å¤–è¿æ¥è¿”å›å…³ç³»ğ‘ ä¸­çš„æ‰€æœ‰è¡Œï¼Œä»¥åŠä¸ğ‘ŸåŒ¹é…çš„è¡Œã€‚å¦‚æœæ²¡æœ‰åŒ¹é…çš„è¡Œï¼Œç»“æœä¼šä¸ºğ‘Ÿä¸­çš„åˆ—å¡«å……ç©ºå€¼ï¼š
        <center>
        $r \rtimes s = (r \bowtie s) \cup \left\{ NULL, NULL, \cdots \right\} \times (s - \pi_{S} (r \bowtie s))$
        </center>
        + å…¨å¤–è¿æ¥ï¼šå…¨å¤–è¿æ¥è¿”å›ä¸¤ä¸ªå…³ç³»çš„æ‰€æœ‰è¡Œï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…çš„è¡Œï¼Œç»“æœä¼šä¸ºå¯¹åº”çš„åˆ—å¡«å……ç©ºå€¼ï¼š
        <center>
        $r âŸ— s = (r \bowtie s) \cup (r - \pi_{R} (r \bowtie s) \times \left\{ NULL, NULL, \cdots \right\}) \cup \left\{ NULL, NULL, \cdots \right\} \times (s - \pi_{S} (r \bowtie s))$
        </center>

+ Semijoin **$\ltimes_{\theta}$** :  $r \ltimes_{\theta} s = \pi_{R}(r \bowtie_{\theta} s)$ï¼Œåç»­æŸ¥è¯¢ä¼˜åŒ–ä¸­å¸¸ç”¨

    ??? eg 
        <center>
        ![](./fig/c2_23.png)
        </center>
        

+ Assignment **$\leftarrow$** 
+ Division **$\div$** : ç»™å®šå…³ç³» $r(R)$ å’Œ $s(S)$ï¼Œæ»¡è¶³$S \in R$, $R \div S$ æ˜¯ä½¿å¾— $t \times s \in r$ çš„æœ€å¤§å…³ç³» $t(R-S)$
    + $s$ çš„å±æ€§é›†åˆå¿…é¡»æ˜¯ $r$ çš„å±æ€§é›†åˆçš„å­é›†
    + $r \div s$ çš„ç»“æœæ˜¯ä¸€ä¸ªå…³ç³»ï¼Œå…¶å±æ€§é›†åˆæ˜¯ $r$ çš„å±æ€§é›†åˆå‡å» $s$ çš„å±æ€§é›†åˆ
    + $r \div s$ çš„ç»“æœæ˜¯ $r$ ä¸­çš„å…ƒç»„ï¼Œä¸”è¿™äº›å…ƒç»„å’Œ $s$ çš„ç¬›å¡å°”ç§¯çš„ç»“æœä¸­çš„æ¯ä¸€ä¸ªå…ƒç»„éƒ½èƒ½åœ¨ $r$ ä¸­æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„å…ƒç»„

    ??? eg 
        <center>
        ![](./fig/c2_24.png)
        </center>
        æ‰§è¡Œ $r \div s$ å¾—åˆ°ï¼š
        <center>
        ![](./fig/c2_25.png)
        </center>

$r \div s$ å¯ä»¥å†™æˆï¼š

$$
\begin{align*}
    temp1 & \leftarrow \Pi_{R-S}(r)\\
    temp2 & \leftarrow \Pi_{R-S}((temp1 \times s)- \Pi_{R-S,S}(r))\\
    result & = temp1 - temp2
\end{align*}
$$

<fontsize = 500px>ä¸Šè¿° additional operations éƒ½æ²¡æœ‰å¢åŠ æŸ¥è¯¢èƒ½åŠ›ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿æŸ¥è¯¢ã€‚</fontsize>

### Extended Relational Algebra Operations

#### Generalized Projection

åœ¨æŠ•å½±çš„æ¡ä»¶ä¸­å…è®¸ä½¿ç”¨ç®—æœ¯è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼š
$\Pi_{ID, Salary, Salary/12}(Instructor)$
çŸ¥é“å¹´è–ªå¯ä»¥æŸ¥è¯¢æœˆè–ª

#### Aggregation Functions and Operations

+ Aggregation Functions: 
    1. AVG: å¹³å‡å€¼
    2. SUM: æ±‚å’Œ
    3. COUNT: è®¡æ•°(éç©º)
    4. MAX: æœ€å¤§å€¼
    5. MIN: æœ€å°å€¼

+ Aggregation Operations in relational algebra
<center>
$_{G_1, G_2, \cdots, G_n}\mathcal{G}_{F_1(A_1), F_2(A_2), \cdots, F_n(A_n)}(E)$
</center>

    å…¶ä¸­ï¼š
    + $G_1, G_2, \cdots, G_n$ æ˜¯åˆ†ç»„å±æ€§
    + $F_1(A_1), F_2(A_2), \cdots, F_n(A_n)$ æ˜¯ä¸Šè¿°äº”ç§èšåˆå‡½æ•°ï¼Œ$A_i$ æ˜¯å±æ€§
    + $E$ æ˜¯ä»»ä½•ä¸€ä¸ªå…³ç³»ä»£æ•°è¡¨è¾¾å¼